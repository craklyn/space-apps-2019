<!DOCTYPE html>
<html>

<head>
    <title>{{ title }}</title>

    <!-- Add references to the Azure Maps Map control JavaScript and CSS files. -->
    <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.css" type="text/css">
    <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.js"></script>

    <!-- Reference to the Bing Maps SDK -->
    <script type='text/javascript'
        src='http://www.bing.com/api/maps/mapcontrol?callback=GetMap&key=AkAArX7aOM5zd5TdIL80WzdoycB1DnM1DxyNuCDnqWsdD7AQXOGz4Cb8-a0iQCXv'
        async defer></script>

    <style>
        html,
        body {
            margin: 0;
        }

        #myMap {
            height: 100vh;
            width: 100vw;
        }
    </style>
</head>

<body>

    <img id="photo"/>
    <script type='text/javascript'>
        function GetMap() {
            var map = new Microsoft.Maps.Map('#myMap');

            //Add your post map load code here.

            var quadKeyToTileLocRect = {};

            //Define a custom overlay class that inherts from the CustomOverlay class.
            TopographicOverlay.prototype = new Microsoft.Maps.CustomOverlay();

            var bounds = Microsoft.Maps.LocationRect.fromString("47.754097979680026,-122.6953125,47.63578359086485,-122.51953125");
            var imageSrc = 'https://t.ssl.ak.dynamic.tiles.virtualearth.net/comp/ch/02123002130?mkt=en-US&it=G,BX,RL&shading=hill&n=z&og=526&c4w=1&cstl=rd';

            //Define a constructor for the custom overlay class.
            function TopographicOverlay(bounds, image) {
                this.bounds = bounds;
                this.image = image;
            }
            //Implement the onAdd method to set up DOM elements, and use setHtmlElement to bind it with the overlay.
            TopographicOverlay.prototype.onAdd = function () {
                img = document.createElement('img');
                img.src = this.image;
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.position = 'absolute';
                this.setHtmlElement(img);
            };
            TopographicOverlay.prototype.onLoad = function () {
                repositionOverlay();

                //Update the position of the image when the view changes.
                Microsoft.Maps.Events.addHandler(map, 'viewchange', function () {
                    repositionOverlay();
                });
            }
            function repositionOverlay() {
                var topLeft = map.tryLocationToPixel(bounds.getNorthwest(), Microsoft.Maps.PixelReference.control);
                var bottomRight = map.tryLocationToPixel(bounds.getSoutheast(), Microsoft.Maps.PixelReference.control);
                if (topLeft && bottomRight) {
                    img.style.left = topLeft.x + 'px';
                    img.style.top = topLeft.y + 'px';
                    img.style.width = (bottomRight.x - topLeft.x) + 'px';
                    img.style.width = (bottomRight.x - topLeft.x) + 'px';
                    img.style.height = (bottomRight.y - topLeft.y) + 'px';
                }
            }

            //Implement the new custom overlay class. 
            var overlay = new TopographicOverlay(bounds, imageSrc);

            //Add the custom overlay to the map.
            map.layers.insert(overlay);

            //Load the Spatial Math module.
            Microsoft.Maps.loadModule("Microsoft.Maps.SpatialMath", function () {
                showMapTileBounds();

                //Recalculate the map tiles bounds everytime the map moves.
                Microsoft.Maps.Events.addHandler(map, 'viewchangeend', showMapTileBounds);
            });
            
            async function showMapTileBounds() {
                map.entities.clear();
                //Get a list of all the tiles in the current map view.
                var tiles = Microsoft.Maps.SpatialMath.Tiles.getTilesInBounds(map.getBounds(), map.getZoom());
                for (var i = 0; i < tiles.length; i++) {
                    //Calculate the bounding rectangle of the tile.
                    var tileLocRect = Microsoft.Maps.SpatialMath.Tiles.tileToLocationRect(tiles[i]);

                    var quadKey = tiles[i].quadKey;
                    var imageUrl = "https://t.ssl.ak.dynamic.tiles.virtualearth.net/comp/ch/"+quadKey+"?mkt=en-US&it=A,G,RL&shading=hill&n=z&og=526&c4w=1"

                    // This dictionary is used in the callback after the HTTP request so that we can get the TileLocRect
                    quadKeyToTileLocRect[quadKey] = tileLocRect;
                    
                    // Create POST request
                    var xhr = new XMLHttpRequest();
                    xhr.open( "POST", "http://127.0.0.1:5000/image", true );
                    xhr.setRequestHeader('Content-Type', 'application/json')

                    // Ask for the result as an ArrayBuffer.
                    xhr.responseType = "arraybuffer";
                
                    // Set a callback that will get called when the call is returned from the service
                    xhr.onload = function( e ) {
                        var quadKeyFromResponseHeader = this.getResponseHeader("X-quadKey");
                        var tileLocRectInCallback = quadKeyToTileLocRect[quadKeyFromResponseHeader];

                        console.log("quadKeyFromResponseHeader: " + quadKeyFromResponseHeader + " | tileLocRectInCallback: " + tileLocRectInCallback);

                        // Obtain a blob: URL for the image data.
                        var arrayBufferView = new Uint8Array( this.response );
                        var blob = new Blob( [ arrayBufferView ], { type: "image/jpeg" } );

                        // we now have an image blob - this is where we would set it on the map as a tile
        

                        var urlCreator = window.URL || window.webkitURL;
                        var imageUrl = urlCreator.createObjectURL( blob );
                        var img = document.querySelector( "#photo" );
                        img.src = imageUrl;
                    };

                    xhr.send(JSON.stringify({ "quadKey": quadKey, "imageUrl": imageUrl, "tileLocRect": tileLocRect}));
                }
            }
        }
    </script>

    <div id="myMap" style="position: absolute;width:100%;height:100%;"></div>

    <!-- =================== Old code to send a request ============================= -->

    <!-- // let response = await fetch("http://127.0.0.1:5000/image");
    // if (response.ok) { // if HTTP-status is 200-299
    //      // get the response body (the method explained below)
    //     let coolResponse = await response; //.arrayBuffer();
    //     console.log(coolResponse);                  

    //     var arrayBufferView = new Uint8Array( coolResponse );
    //     var blob = new Blob( [ arrayBufferView ], { type: "image/jpeg" } );  
    //     console.log(blob);                  
    //     var urlCreator = window.URL || window.webkitURL;
    //     var imageUrl = urlCreator.createObjectURL( blob );
    //     console.log(imageUrl);
    //     var img = document.querySelector( "#photo" );
    //     img.src = imageUrl;

    // } else {
    //     alert("HTTP-Error: " + response.status);
    // } -->

    <!-- ==================== Old code to look at ============================ -->

    <!-- <script type='text/javascript'>
    // function sleep(ms) {
    //     return new Promise(resolve => setTimeout(resolve, ms));
    // }
    // async function demo() {
    //     console.log('Taking a break...');
    //     await sleep(2000);
    //         var resources = window.performance.getEntriesByType("resource");
    //     resources.forEach(function (resource) {
    //         console.log(resource);
    //     });
    // }
    // demo();

    </script> -->

    <!-- ================================================ -->

        <!-- Azure Maps
        <div id="myMap"></div>
        <script type="text/javascript">
        //Create an instance of the map control and set some options.
        var map = new atlas.Map('myMap', {
            center: [-122.33, 47.6],
            zoom: 12,
            language: 'en-US',
            authOptions: {
                authType: 'subscriptionKey',
                subscriptionKey: 'vpNJNb5Nn-pUu43qtJhlf_RM5A6_80Gd6qSxBIcQqBs'
            }
        });
        </script> -->

</body>

</html>